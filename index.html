<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>倉庫訂餐網</title>
<style>
:root{--page-width:900px;--bg:#fff4ea}
body{background:var(--bg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;color:#333;margin:0;display:flex;min-height:100vh;align-items:flex-start;justify-content:center;padding:40px 20px}
.container{width:100%;max-width:var(--page-width);background:white;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:24px;box-sizing:border-box}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
input[type=date],input[type=text],input[type=number]{padding:8px;border-radius:6px;border:1px solid #ddd}
input[type=text]{flex:1}
select{padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:8px 12px;border-radius:8px;border:0;background:#ff8a4b;color:#fff;cursor:pointer}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{border:1px dashed #ffd3b8;padding:12px;border-radius:8px;background:#fff7f0}
.orders{margin-top:18px;border-top:1px solid #eee;padding-top:12px}
.order-item{background:#fff; padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #faf0e6;position:relative}
.small{font-size:13px;color:#666}
.note{font-size:13px;color:#666;margin-top:6px}
.drink-buttons{display:flex;gap:8px;flex-wrap:wrap}
.drink-buttons button{background:#ff7b7b}
.hidden{display:none}
.delete-btn{background:#ff4b4b;color:#fff;padding:4px 8px;border-radius:6px;border:0;margin-top:6px;cursor:pointer;position:absolute;right:10px;top:10px}
</style>
</head>
<body>
<div class="container" role="application">
  <h1>倉庫訂餐網</h1>

  <!-- Login page -->
  <div id="page-login">
    <div class="row">
      <label for="empId">員工工號</label>
      <input id="empId" type="text" placeholder="輸入工號 (6碼)" />
    </div>
    <div class="center">
      <button id="btnLogin">登入</button>
    </div>
  </div>

  <!-- Home page -->
  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="row">
      <label for="orderDate">訂餐日期</label>
      <input id="orderDate" type="date" />
    </div>
    <div class="center">
      <button id="toLunch">午餐</button>
      <button id="toDrinks" class="secondary">飲料</button>
    </div>
  </div>

  <!-- Lunch page -->
  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">餐廳名稱</label>
      <select id="restaurant"></select>
    </div>
    <div class="menu-area">
      <div class="row">
        <label>餐點選擇</label>
        <select id="menuItem"></select>
      </div>
      <div class="row" id="additionalRow">
        <label>飯麵</label>
        <select id="potMain" class="hidden">
          <option value="紅醬">紅醬</option>
          <option value="白醬">白醬</option>
          <option value="青醬">青醬</option>
          <option value="素醬">素醬</option>
          <option value="直麵">直麵</option>
          <option value="筆尖麵">筆尖麵</option>
        </select>
      </div>
      <div class="row">
        <label>調味/辣度</label>
        <select id="spice">
          <option>不加</option>
          <option>微辣</option>
          <option>小辣</option>
          <option>辣</option>
          <option>加醋</option>
        </select>
      </div>
      <div class="row">
        <label>數量</label>
        <input id="qty" type="number" min="1" value="1" style="width:70px" />
      </div>
      <div class="row">
        <label>備註</label>
        <input id="note" placeholder="例:少醬、不要蔥" />
      </div>
      <div class="center">
        <button id="addLunch">新增訂單（送出到團主）</button>
        <button id="backFromLunch" class="secondary">回上一頁</button>
      </div>
    </div>
  </div>

  <!-- Drinks page -->
  <div id="page-drinks" class="hidden">
    <div class="row">
      <label>飲料店</label>
      <div class="drink-buttons">
        <button data-url="https://order.nidin.shop/gb/menu/20202/sayaBJ05B4">樂法</button>
        <button data-url="https://order.nidin.shop/gb/menu/13924/f26pUd_XuQ">五桐號</button>
      </div>
    </div>
    <div class="center">
      <button id="backFromDrinks" class="secondary">回上一頁</button>
    </div>
  </div>

  <div class="orders">
    <h3>我的訂單（即時顯示）</h3>
    <div id="ordersList"></div>
    <p class="note">僅顯示你本人的訂單，可隨時刪除。</p>
  </div>
</div>

<script>
// --- Config ---
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzuZV7VtIXWtuaQGQV37pIz2g0E42WE6MY6jZJd1f1ht4E8zXqlDr8BifzV9QGfBHqd/exec";
let CURRENT_USER = null;
let MENUS = {};

// DOM 快捷
const el = id => document.getElementById(id);
const ordersList = el('ordersList');
const restaurantSel = el('restaurant');
const menuItemSel = el('menuItem');
const potMainSel = el('potMain');

// 初始化：抓取菜單
async function loadMenus(){
  const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
  MENUS = await res.json();
  restaurantSel.innerHTML = '';
  Object.keys(MENUS).forEach(r=>{
    const o = document.createElement('option');
    o.value=r; o.textContent=r;
    restaurantSel.appendChild(o);
  });
  populateMenu(restaurantSel.value);
}

function populateMenu(restaurant){
  menuItemSel.innerHTML='';
  const items = MENUS[restaurant] || [];
  let lastCat = null;
  items.forEach(it=>{
    if(it.cat !== lastCat){
      const opt = document.createElement('option');
      opt.disabled=true; opt.textContent = it.cat; opt.style.fontWeight='600';
      menuItemSel.appendChild(opt);
      lastCat = it.cat;
    }
    const option = document.createElement('option');
    option.value = JSON.stringify({name:it.name,price:it.price});
    option.textContent = `${it.name} — ${it.price}元`;
    menuItemSel.appendChild(option);
  });
  potMainSel.classList.add('hidden');
}
menuItemSel.addEventListener('change', ()=>{
  const raw = menuItemSel.value;
  if(!raw) return;
  const selected = JSON.parse(raw);
  if(selected.name.includes("焗烤飯") || selected.name.includes("焗烤麵")){
    potMainSel.classList.remove('hidden');
  } else if(selected.name.includes("義大利麵")){
    potMainSel.classList.remove('hidden');
  } else {
    potMainSel.classList.add('hidden');
  }
});
restaurantSel.addEventListener('change', ()=>populateMenu(restaurantSel.value));

// 渲染訂單
async function renderOrders(){
  if(!CURRENT_USER) return;
  const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
  const data = await res.json();
  ordersList.innerHTML='';
  data.forEach((o,idx)=>{
    const div = document.createElement('div'); 
    div.className='order-item';
    div.innerHTML = `
      <strong>#${idx+1} ${o.restaurant} - ${o.item}</strong>
      <div class="small">日期: ${o.date} | 員工: ${o.employee} | 數量: ${o.qty} | 價格: ${o.price} 元 | 調味: ${o.spice}</div>
      <div class='small'>備註: ${o.note || ''}</div>
      <button class="delete-btn" data-id="${o.id}">刪除</button>
    `;
    ordersList.appendChild(div);
  });
  document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(confirm('確定要刪除此筆訂單嗎？')){
        const params = new URLSearchParams();
        params.append("action","delete");
        params.append("id", btn.dataset.id);
        params.append("employee", CURRENT_USER.name);
        await fetch(GOOGLE_WEBAPP_URL,{
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body:params
        });
        renderOrders();
      }
    });
  });
}

// 新增午餐訂單
el('addLunch').addEventListener('click', async ()=>{
  const date = el('orderDate').value;
  if(!date){ alert('請先選擇訂餐日期'); return; }
  const restaurant = restaurantSel.value;
  if(!menuItemSel.value){ alert('請選擇餐點'); return; }
  const itemObj = JSON.parse(menuItemSel.value);
  const spice = el('spice').value;
  const qty = parseInt(el('qty').value)||1;
  const note = el('note').value||'';
  const potMain = potMainSel.classList.contains('hidden')?'':potMainSel.value;

  const params = new URLSearchParams();
  params.append("date",date);
  params.append("employee",CURRENT_USER.name);
  params.append("restaurant",restaurant);
  params.append("item",itemObj.name);
  params.append("price",itemObj.price);
  params.append("spice",spice);
  params.append("qty",qty);
  params.append("note",note);
  params.append("potMain",potMain);

  const res = await fetch(GOOGLE_WEBAPP_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:params
  });
  await res.json();
  alert("訂單已新增");
  renderOrders();
});

// Page navigation
const pageLogin = el('page-login');
const pageHome = el('page-home');
const pageLunch = el('page-lunch');
const pageDrinks = el('page-drinks');

el('toLunch').addEventListener('click', ()=>{ pageHome.classList.add('hidden'); pageLunch.classList.remove('hidden'); });
el('toDrinks').addEventListener('click', ()=>{ pageHome.classList.add('hidden'); pageDrinks.classList.remove('hidden'); });
el('backFromLunch').addEventListener('click', ()=>{ pageLunch.classList.add('hidden'); pageHome.classList.remove('hidden'); });
el('backFromDrinks').addEventListener('click', ()=>{ pageDrinks.classList.add('hidden'); pageHome.classList.remove('hidden'); });

// 飲料連結
document.querySelectorAll('.drink-buttons button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const url = btn.dataset.url || '';
    if(!url){ alert('此店網址尚未提供'); return; }
    window.open(url,'_blank');
  });
});

// Login
el('btnLogin').addEventListener('click', async ()=>{
  const empId = el('empId').value.trim();
  const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
  const employees = await res.json();
  const found = employees.find(e=>String(e.id)===empId);
  if(found){
    CURRENT_USER = found;
    pageLogin.classList.add('hidden');
    pageHome.classList.remove('hidden');
    el('welcome').textContent = `歡迎 ${found.name}`;
    loadMenus();
    renderOrders();
  }else{
    alert("工號不存在");
  }
});
</script>
</body>
</html>
